{% extends 'base.html' %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

<style>
    /* --- Global & Theme Transition --- */
    body {
        margin: 0;
        overflow-x: hidden;
        background-color: #f1f5f9; /* Day Base */
        transition: background-color 1s ease;
        font-family: 'Tajawal', sans-serif;
    }
    .dark body { background-color: #050505; /* Night Base */ }

    /* --- 3D Canvas --- */
    #earth-canvas {
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        z-index: 0;
        outline: none;
    }

    /* --- UI Layer --- */
    .ui-layer {
        position: relative;
        z-index: 10;
        pointer-events: none;
    }

    /* --- Scroll Sections --- */
    .viewport-section {
        height: 120vh; 
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    /* --- HUD Card System --- */
    .hud-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-bottom: 5px solid #10B981;
        padding: 60px;
        text-align: center;
        color: #1e293b;
        width: 90%;
        max-width: 750px;
        border-radius: 24px;
        opacity: 0;
        transform: translateY(40px) scale(0.95);
        transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 0 40px 100px rgba(0,0,0,0.05);
    }

    .dark .hud-card {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
        box-shadow: 0 50px 150px rgba(0, 0, 0, 0.6);
    }

    .viewport-section.active .hud-card {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }

    /* --- Feature Cards Styling --- */
    .feature-card {
        max-width: 600px;
        /* Logical Property for RTL/LTR support */
        border-inline-start: 6px solid #10B981;
        border-bottom: none;
        text-align: start;
    }

    /* --- Typography --- */
    .hud-title {
        font-size: 3.5rem;
        font-weight: 900;
        margin-bottom: 15px;
        letter-spacing: -1px;
    }
    
    .hud-desc {
        font-size: 1.4rem;
        opacity: 0.8;
        line-height: 1.6;
    }

    /* --- Buttons --- */
    .cta-btn {
        display: inline-block;
        margin-top: 40px;
        padding: 18px 60px;
        background: #10B981;
        color: white;
        font-weight: 800;
        text-decoration: none;
        border-radius: 12px;
        transition: transform 0.3s ease, background 0.3s ease;
        pointer-events: auto;
        font-size: 1.2rem;
    }
    .cta-btn:hover {
        background: #059669;
        transform: translateY(-5px);
    }

    /* --- Credits --- */
    .footer-credits {
        position: fixed;
        bottom: 25px;
        width: 100%;
        text-align: center;
        z-index: 100;
        font-size: 12px;
        color: rgba(150, 150, 150, 0.5);
        font-family: monospace;
        letter-spacing: 2px;
        pointer-events: none;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}

<div id="earth-canvas"></div>
<div class="footer-credits">Developed by <b>KhalidExe</b> Â© 2026</div>

<div class="ui-layer">
    
    <div class="viewport-section active" id="sec-0">
        <div class="hud-card">
            <h1 class="hud-title">{{ texts['app_name'][lang] }}</h1>
            <p class="hud-desc">{{ texts['hero_title'][lang] }}</p>
            <div class="mt-6">
                {% if current_user.is_authenticated %}
                <a href="/dashboard" class="cta-btn">{{ texts['go_dashboard'][lang] }}</a>
                {% else %}
                <a href="/signup" class="cta-btn">{{ texts['start_now'][lang] }}</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="viewport-section" id="sec-1" style="justify-content: flex-start; padding-inline-start: 10%;">
        <div class="hud-card feature-card">
            <div class="text-7xl mb-6">ðŸ”’</div>
            <h2 class="hud-title" style="font-size: 2.5rem;">{{ texts['feat_security_title'][lang] }}</h2>
            <p class="hud-desc">{{ texts['feat_security_desc'][lang] }}</p>
        </div>
    </div>

    <div class="viewport-section" id="sec-2" style="justify-content: flex-end; padding-inline-end: 10%;">
        <div class="hud-card feature-card" style="border-inline-start-color: #F97316;">
            <div class="text-7xl mb-6">ðŸ“Š</div>
            <h2 class="hud-title" style="font-size: 2.5rem;">{{ texts['feat_reports_title'][lang] }}</h2>
            <p class="hud-desc">{{ texts['feat_reports_desc'][lang] }}</p>
        </div>
    </div>

</div>

<script>
    gsap.registerPlugin(ScrollTrigger);

    // --- Global State ---
    let scene, camera, renderer;
    let wallMaterial, roofMaterial, groundMaterial;
    let ambientLight, sunLight;
    const isDark = () => document.documentElement.classList.contains('dark');

    // --- Config ---
    const CONFIG = {
        buildings: 4000,
        spread: 1600,
        themes: {
            night: {
                bg: 0x010204, fog: 0x010204, 
                ambient: 0.8, sun: 0.3, 
                wallColor: 0x1e293b, emissiveInt: 1.8,
                roofColor: 0x0a0a0a
            },
            day: {
                bg: 0xf1f5f9, fog: 0xf1f5f9, 
                ambient: 1.1, sun: 1.8, 
                wallColor: 0xe2e8f0, emissiveInt: 0.0,
                roofColor: 0x334155
            }
        }
    };

    function init() {
        // 1. Setup Scene
        scene = new THREE.Scene();
        const mode = isDark() ? 'night' : 'day';
        applyThemeEnvironment(mode);

        // 2. Setup Camera
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 8000);
        
        // 3. Setup Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('earth-canvas').appendChild(renderer.domElement);

        // 4. Create Assets
        createCity();
        createGround();
        createLighting(mode);

        // 5. Logic
        setupAnimation();
        setupThemeObserver();
        animate();
    }

    // --- Texture Generator (High Res) ---
    function createBuildingTexture() {
        const c = document.createElement('canvas');
        c.width = 512; c.height = 1024;
        const ctx = c.getContext('2d');
        
        // Base
        ctx.fillStyle = '#ffffff'; 
        ctx.fillRect(0,0,512,1024);
        
        // Windows Pattern
        ctx.fillStyle = '#111111';
        for(let y=0; y<1024; y+=32) {
            for(let x=0; x<512; x+=16) {
                if(Math.random() > 0.45) {
                    ctx.fillRect(x+2, y+2, 12, 24);
                }
            }
        }
        
        const tex = new THREE.CanvasTexture(c);
        tex.anisotropy = renderer.capabilities.getMaxAnisotropy();
        return tex;
    }

    // --- City Builder ---
    function createCity() {
        const tex = createBuildingTexture();
        
        // Material 1: Walls (Glass/Window Texture)
        wallMaterial = new THREE.MeshStandardMaterial({
            map: tex, 
            emissiveMap: tex,
            color: 0xffffff,
            roughness: 0.1, // Glassy
            metalness: 0.7
        });

        // Material 2: Roof (Solid Concrete)
        roofMaterial = new THREE.MeshStandardMaterial({
            color: 0x333333,
            roughness: 0.9,
            metalness: 0.1
        });

        // Box Geometry with separate material groups
        // Materials array: [Right, Left, Top, Bottom, Front, Back]
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        geometry.translate(0, 0.5, 0);

        const mesh = new THREE.InstancedMesh(geometry, [wallMaterial, wallMaterial, roofMaterial, roofMaterial, wallMaterial, wallMaterial], CONFIG.buildings);
        mesh.castShadow = true;
        mesh.receiveShadow = true;

        const dummy = new THREE.Object3D();
        const _yAxis = new THREE.Vector3(0,1,0);

        for(let i=0; i<CONFIG.buildings; i++) {
            const angle = Math.random() * Math.PI * 2;
            const radius = Math.pow(Math.random(), 1.5) * CONFIG.spread;
            let x = Math.cos(angle) * radius;
            let z = Math.sin(angle) * radius;

            // Clear Flight Path (Wide Avenue)
            if(Math.abs(x) < 80) x += 150 * Math.sign(x);
            
            // Height Logic (Mega Towers)
            let h;
            const r = Math.random();
            if(r > 0.99) h = 450 + Math.random() * 100; // Landmark
            else if(r > 0.9) h = 200 + Math.random() * 150;
            else h = 30 + Math.random() * 80;

            dummy.position.set(x, 0, z);
            dummy.scale.set(20 + Math.random()*25, h, 20 + Math.random()*25);
            dummy.updateMatrix();
            mesh.setMatrixAt(i, dummy.matrix);
        }
        scene.add(mesh);
    }

    function createGround() {
        groundMaterial = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.2 });
        const plane = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), groundMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);
    }

    function createLighting(mode) {
        const theme = CONFIG.themes[mode];
        
        ambientLight = new THREE.AmbientLight(0xffffff, theme.ambient);
        scene.add(ambientLight);

        sunLight = new THREE.DirectionalLight(0xffffff, theme.sun);
        sunLight.position.set(300, 800, 200);
        sunLight.castShadow = true;
        // Optimize Shadows
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.far = 2000;
        sunLight.shadow.camera.left = -1000;
        sunLight.shadow.camera.right = 1000;
        scene.add(sunLight);
    }

    // --- Cinematic Camera ---
    function setupAnimation() {
        // Start: Panoramic Overview (High & Far)
        camera.position.set(0, 600, 1200);
        camera.lookAt(0, 100, 0);

        const tl = gsap.timeline({
            scrollTrigger: { trigger: "body", start: "top top", end: "bottom bottom", scrub: 1.5 }
        });

        // Move 1: Dive into the City (Majestic)
        tl.to(camera.position, { x: 300, y: 250, z: 400, ease: "power2.inOut" })
          .to(camera.rotation, { x: -0.2, y: 0.3, z: 0, ease: "power2.inOut" }, "<")

        // Move 2: Fly along the Avenue (Mid-level)
          .to(camera.position, { x: 0, y: 150, z: -500, ease: "none" })
          .to(camera.rotation, { x: 0, y: 0, z: 0, ease: "none" }, "<")

        // Move 3: Ascend to Skyline (Outro)
          .to(camera.position, { x: -500, y: 800, z: -1000, ease: "power2.out" })
          .to(camera.rotation, { x: -0.5, y: -0.8, z: 0, ease: "power2.out" }, "<");

        // UI Triggers
        document.querySelectorAll('.viewport-section').forEach(sec => {
            ScrollTrigger.create({
                trigger: sec, start: "top center", end: "bottom center",
                onEnter: () => sec.classList.add('active'),
                onLeave: () => sec.classList.remove('active'),
                onEnterBack: () => sec.classList.add('active')
            });
        });
    }

    // --- Theme Logic ---
    function applyThemeEnvironment(mode) {
        const theme = CONFIG.themes[mode];
        scene.background = new THREE.Color(theme.bg);
        scene.fog = new THREE.FogExp2(theme.fog, 0.0012);
    }

    function updateMaterials(mode) {
        const theme = CONFIG.themes[mode];
        
        // Animate Environment
        gsap.to(scene.background, { r: new THREE.Color(theme.bg).r, g: new THREE.Color(theme.bg).g, b: new THREE.Color(theme.bg).b, duration: 1 });
        gsap.to(scene.fog.color, { r: new THREE.Color(theme.fog).r, g: new THREE.Color(theme.fog).g, b: new THREE.Color(theme.fog).b, duration: 1 });
        
        // Animate Lights
        gsap.to(ambientLight, { intensity: theme.ambient, duration: 1 });
        gsap.to(sunLight, { intensity: theme.sun, duration: 1 });

        // Animate Materials
        wallMaterial.color.setHex(theme.wallColor);
        // Toggle Emissive (Lights ON at night, OFF at day)
        wallMaterial.emissive.setHex(mode === 'night' ? 0xffffcc : 0x000000);
        gsap.to(wallMaterial, { emissiveIntensity: theme.emissiveInt, duration: 1 });
        
        roofMaterial.color.setHex(theme.roofColor);
    }

    function setupThemeObserver() {
        const observer = new MutationObserver(() => {
            updateMaterials(isDark() ? 'night' : 'day');
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
        
        // Initial set
        updateMaterials(isDark() ? 'night' : 'day');
    }

    // --- Loop ---
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Start
    init();
</script>
{% endblock %}