{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    
    <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h2 class="text-2xl font-bold text-white mb-1">{{ tenant.name }}</h2>
            <p class="text-slate-400 text-sm flex items-center gap-2">
                üè† {{ tenant.unit_name }}
            </p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="document.getElementById('uploadModal').classList.remove('hidden')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-900/20 flex items-center gap-2">
                üìÇ {{ texts['upload_excel'][lang] }}
            </button>
        </div>
    </div>

    <div class="bg-slate-800 rounded-3xl border border-slate-700 shadow-xl overflow-hidden">
        <div class="p-6 border-b border-slate-700">
            <h3 class="text-xl font-bold text-white">{{ texts['financial_record'][lang] }}</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-start text-slate-300">
                <thead class="bg-slate-900/50 text-slate-400 font-bold uppercase text-xs">
                    <tr>
                        <th class="p-4 text-start">{{ texts['due_date'][lang] }}</th>
                        <th class="p-4 text-start">{{ texts['amount'][lang] }}</th>
                        <th class="p-4 text-start">{{ texts['total_paid'][lang] }}</th>
                        <th class="p-4 text-start">{{ texts['total_remaining'][lang] }}</th>
                        <th class="p-4 text-start">{{ texts['status'][lang] }}</th>
                        <th class="p-4 text-start">{{ texts['actions'][lang] }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-700">
                    {% for inst in installments %}
                    <tr class="hover:bg-slate-700/50 transition-colors">
                        <td class="p-4 font-mono text-sm">{{ inst.date }}</td>
                        <td class="p-4 font-bold text-white">{{ "{:,.0f}".format(inst.amount) }}</td>
                        <td class="p-4 text-emerald-400">{{ "{:,.0f}".format(inst.paid) }}</td>
                        <td class="p-4 text-rose-400">{{ "{:,.0f}".format(inst.amount - inst.paid) }}</td>
                        <td class="p-4">
                            {% if inst.paid >= inst.amount %}
                                <span class="bg-emerald-900/30 text-emerald-400 px-3 py-1 rounded-full text-xs font-bold border border-emerald-500/30">
                                    {{ texts['paid_done'][lang] }}
                                </span>
                            {% elif inst.paid > 0 %}
                                <span class="bg-yellow-900/30 text-yellow-400 px-3 py-1 rounded-full text-xs font-bold border border-yellow-500/30">
                                    {{ texts['partial'][lang] }}
                                </span>
                            {% else %}
                                <span class="bg-slate-700 text-slate-400 px-3 py-1 rounded-full text-xs font-bold">
                                    {{ texts['unpaid'][lang] }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="p-4 flex gap-2">
                            <button onclick="openPayModal('{{ inst.id }}', '{{ inst.amount - inst.paid }}')" class="bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                                üí∞ {{ texts['pay'][lang] }}
                            </button>
                            <button onclick="openEditModal('{{ inst.id }}', '{{ inst.amount }}')" class="bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all">
                                ‚úèÔ∏è
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not installments %}
            <div class="p-12 text-center">
                <p class="text-slate-500 mb-4">{{ texts['no_tenants'][lang] }}</p>
                <button onclick="document.getElementById('uploadModal').classList.remove('hidden')" class="text-blue-400 hover:text-blue-300 text-sm font-bold underline">
                    {{ texts['upload_excel'][lang] }}
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="uploadModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-slate-800 w-full max-w-md rounded-3xl border border-slate-700 shadow-2xl p-6 relative">
        <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="absolute top-4 right-4 rtl:left-4 rtl:right-auto text-slate-400 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold text-white mb-6">{{ texts['upload_excel'][lang] }}</h3>
        <form action="{{ url_for('upload_excel', t_id=tenant.id) }}" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="border-2 border-dashed border-slate-600 rounded-xl p-8 text-center hover:border-blue-500 transition-colors cursor-pointer relative">
                <input type="file" name="file" accept=".xlsx" required class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
                <p class="text-slate-400 text-sm">Drag & Drop or Click to Upload</p>
                <p class="text-slate-600 text-xs mt-2">(.xlsx files only)</p>
            </div>
            <button type="submit" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-emerald-900/20">
                {{ texts['upload_excel'][lang] }}
            </button>
        </form>
    </div>
</div>

<div id="payModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-slate-800 w-full max-w-sm rounded-3xl border border-slate-700 shadow-2xl p-6 relative">
        <button onclick="document.getElementById('payModal').classList.add('hidden')" class="absolute top-4 right-4 rtl:left-4 rtl:right-auto text-slate-400 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold text-white mb-6">{{ texts['pay'][lang] }}</h3>
        <form id="payForm" method="POST" class="space-y-4">
            <input type="hidden" name="t_id" value="{{ tenant.id }}">
            <div>
                <label class="block text-slate-400 text-xs font-bold mb-1">{{ texts['amount'][lang] }}</label>
                <input type="number" step="0.01" name="amount" id="payAmount" required class="w-full p-3 bg-slate-900 border border-slate-700 rounded-xl text-white focus:border-blue-500 outline-none">
            </div>
            <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-900/20">
                {{ texts['pay'][lang] }}
            </button>
        </form>
    </div>
</div>

<div id="editModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-slate-800 w-full max-w-sm rounded-3xl border border-slate-700 shadow-2xl p-6 relative">
        <button onclick="document.getElementById('editModal').classList.add('hidden')" class="absolute top-4 right-4 rtl:left-4 rtl:right-auto text-slate-400 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold text-white mb-6">{{ texts['update'][lang] }}</h3>
        <form id="editForm" method="POST" class="space-y-4">
            <input type="hidden" name="t_id" value="{{ tenant.id }}">
            <div>
                <label class="block text-slate-400 text-xs font-bold mb-1">{{ texts['amount'][lang] }}</label>
                <input type="number" step="0.01" name="new_total" id="editTotal" required class="w-full p-3 bg-slate-900 border border-slate-700 rounded-xl text-white focus:border-blue-500 outline-none">
            </div>
            <button type="submit" class="w-full py-3 bg-slate-600 hover:bg-slate-500 text-white font-bold rounded-xl transition-all">
                {{ texts['update'][lang] }}
            </button>
        </form>
    </div>
</div>

<script>
    function openPayModal(id, remaining) {
        document.getElementById('payForm').action = '/pay/' + id;
        document.getElementById('payAmount').value = remaining;
        document.getElementById('payModal').classList.remove('hidden');
    }

    function openEditModal(id, total) {
        document.getElementById('editForm').action = '/update_total/' + id;
        document.getElementById('editTotal').value = total;
        document.getElementById('editModal').classList.remove('hidden');
    }
</script>
{% endblock %}